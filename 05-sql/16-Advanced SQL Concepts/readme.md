# Advanced SQL Concepts

**Advanced SQL concepts** охоплюють складні техніки та можливості, які виходять за межі базових запитів і маніпуляцій з даними. Сюди входять: складні JOIN-и, підзапити, віконні функції, збережені процедури, тригери, рекурсивні запити, CTE, динамічний SQL, advanced indexing, pivot/unpivot тощо. Володіння цими інструментами дозволяє оптимізувати продуктивність, реалізовувати складну бізнес-логіку, забезпечувати цілісність даних і виконувати глибокий аналіз.

---

## Dynamic SQL

**Dynamic SQL** — це спосіб формування SQL-запитів динамічно під час виконання програми. Дозволяє будувати запити на основі вхідних параметрів або умов, які невідомі заздалегідь.

- Гнучкість, але ризик SQL-ін'єкцій — завжди валідуйте та санітуйте вхідні дані!
- Приклад (PostgreSQL):

  ```sql
  EXECUTE format('SELECT * FROM users WHERE %I = $1', column_name) USING value;
  ```

---

## CTE (Common Table Expressions)

**CTE** — це іменований тимчасовий результат, який можна використовувати у межах одного запиту. Оголошується через WITH.

- Покращує читабельність, дозволяє розбивати складні запити на частини.
- Підтримує рекурсію.

  ```sql
  WITH active_users AS (
    SELECT * FROM users WHERE is_active = TRUE
  )
  SELECT * FROM active_users WHERE created_at > '2024-01-01';
  ```

---

## Pivot та Unpivot

- **PIVOT** — перетворює рядки у стовпці (наприклад, місяці стають окремими стовпцями).
- **UNPIVOT** — навпаки, перетворює стовпці у рядки.
- Корисно для звітності та візуалізації.
- Синтаксис залежить від СУБД (наприклад, в MS SQL Server — оператор PIVOT).

---

## Recursive Queries

**Рекурсивні запити** дозволяють обробляти ієрархічні структури (дерева, графи).

- Використовують рекурсивний CTE:

  ```sql
  WITH RECURSIVE subordinates AS (
    SELECT id, manager_id, name FROM employees WHERE manager_id IS NULL
    UNION ALL
    SELECT e.id, e.manager_id, e.name
    FROM employees e
    JOIN subordinates s ON e.manager_id = s.id
  )
  SELECT * FROM subordinates;
  ```

---

## Window Functions

**Віконні функції** дозволяють виконувати обчислення над набором рядків, пов'язаних з поточним рядком (window).

- Приклади:
  - `ROW_NUMBER()` — унікальний номер рядка у межах групи.
  - `LEAD()` — значення з наступного рядка.
  - `LAG()` — значення з попереднього рядка.
  - `DENSE_RANK()` — ранг без пропусків.
  - `RANK()` — ранг з пропусками при однакових значеннях.
- Синтаксис:

  ```sql
  SELECT name, salary,
         ROW_NUMBER() OVER (PARTITION BY department ORDER BY salary DESC) AS rn,
         LAG(salary) OVER (ORDER BY salary DESC) AS prev_salary
  FROM employees;
  ```

---

## Interview Questions

- Що таке dynamic SQL? Які ризики його використання?
- Для чого використовують CTE? Як виглядає рекурсивний CTE?
- Як працюють PIVOT та UNPIVOT?
- Для чого потрібні рекурсивні запити?
- Що таке віконні функції? Наведіть приклади використання ROW_NUMBER, RANK, LAG, LEAD.
- Як за допомогою SQL отримати ієрархічні дані?
- Як оптимізувати складні аналітичні запити?

---

## What to Answer

- **Що таке dynamic SQL? Які ризики його використання?**
  - Dynamic SQL — це формування SQL-запитів під час виконання програми. Головний ризик — SQL-ін'єкції, тому завжди потрібно перевіряти та санітизувати вхідні дані.

- **Для чого використовують CTE? Як виглядає рекурсивний CTE?**
  - CTE (Common Table Expression) використовують для спрощення складних запитів, підвищення читабельності та повторного використання підзапитів. Рекурсивний CTE дозволяє працювати з ієрархічними структурами (дерева, графи).

    ```sql
    WITH RECURSIVE subordinates AS (
      SELECT id, manager_id FROM employees WHERE manager_id IS NULL
      UNION ALL
      SELECT e.id, e.manager_id FROM employees e
      JOIN subordinates s ON e.manager_id = s.id
    )
    SELECT * FROM subordinates;
    ```

- **Як працюють PIVOT та UNPIVOT?**
  - PIVOT перетворює рядки у стовпці для зручної агрегації та звітності (наприклад, місяці як окремі стовпці). UNPIVOT — навпаки, перетворює стовпці у рядки. Синтаксис залежить від СУБД.

- **Для чого потрібні рекурсивні запити?**
  - Для обробки ієрархічних або рекурсивних структур даних (наприклад, організаційна структура, дерево категорій, ланцюжки підпорядкування).

- **Що таке віконні функції? Наведіть приклади використання ROW_NUMBER, RANK, LAG, LEAD.**
  - Віконні функції виконують обчислення над набором рядків, пов'язаних з поточним рядком, без агрегації всієї групи.
    - `ROW_NUMBER()` — унікальний номер рядка у межах групи.
    - `RANK()` — ранг з пропусками при однакових значеннях.
    - `DENSE_RANK()` — ранг без пропусків.
    - `LAG()` — значення з попереднього рядка.
    - `LEAD()` — значення з наступного рядка.

    ```sql
    SELECT name, salary,
           ROW_NUMBER() OVER (ORDER BY salary DESC) AS rn,
           LAG(salary) OVER (ORDER BY salary DESC) AS prev_salary,
           LEAD(salary) OVER (ORDER BY salary DESC) AS next_salary
    FROM employees;
    ```

- **Як за допомогою SQL отримати ієрархічні дані?**
  - За допомогою рекурсивного CTE, який ітерує по зв'язках типу parent-child.

- **Як оптимізувати складні аналітичні запити?**
  - Використовувати CTE для розбиття запиту на частини, віконні функції для аналітики без підзапитів, аналізувати план виконання (EXPLAIN), уникати зайвих JOIN-ів і підзапитів, вибирати лише потрібні стовпці.
